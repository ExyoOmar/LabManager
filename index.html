<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>أداة مختبر الحاسوب</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body { font-family:'Inter', sans-serif; background:#f5f6f8; margin:0; direction:rtl; }
header { background:#ffffff; box-shadow:0 2px 5px rgba(0,0,0,0.05); padding:20px; text-align:center; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-weight:500; font-size:24px; color:#1f2937; }
.role-select { margin-top:10px; font-size:16px; padding:5px 10px; border-radius:6px; border:1px solid #ccc; }
.container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; padding:20px; }
.computer { width:140px; height:100px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:600; color:#fff; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.08); transition:transform 0.2s, box-shadow 0.2s; text-align:center; }
.computer:hover { transform:translateY(-4px); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
.available { background:#34d399; }
.reserved { background:#fbbf24; }
.maintenance { background:#f87171; }
.control-panel { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); max-width:380px; margin:20px auto; padding:20px; text-align:center; }
.control-panel h3 { margin-top:0; color:#111827; }
textarea { width:100%; padding:8px; margin:10px 0; border-radius:8px; border:1px solid #ccc; resize:none; font-family:'Inter'; font-size:14px; }
button { padding:8px 14px; margin:5px; border:none; border-radius:8px; font-weight:500; cursor:pointer; transition:background 0.2s; }
.reserve-btn { background:#3b82f6; color:#fff; }
.maintenance-btn { background:#ef4444; color:#fff; }
.available-btn { background:#10b981; color:#fff; }
.all-btn { background:#6366f1; color:#fff; }
.make-all-available-btn { background:#06b6d4; color:#fff; }
.filter-btn { background:#f97316; color:#fff; }
button:hover { opacity:0.9; }
.analytics { max-width:380px; margin:20px auto; background:#fff; border-radius:12px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
</style>
</head>
<body>

<header>
<h1>أداة مختبر الحاسوب</h1>
  <h4>عمل الطالب عمر أبو بكر</h4>
<label>اختر الدور:</label>
<select id="roleSelect" class="role-select" onchange="switchRole()">
  <option value="teacher">المعلم</option>
  <option value="it">مسؤول مختبر الحاسوب</option>
</select>
</header>

<div class="container" id="dashboard"></div>

<div class="control-panel" id="controlPanel" style="display:none;">
<h3 id="selectedComputerName">اختر جهاز</h3>
<textarea id="computerNotes" placeholder="اكتب ملاحظة..."></textarea>
<div>
<button class="reserve-btn" onclick="reserveComputer()">حجز الجهاز</button>
<button class="maintenance-btn" onclick="markMaintenance()">وضع في الصيانة</button>
<button class="available-btn" onclick="markAvailable()">متاح</button>
<button class="all-btn" onclick="reserveAll()">حجز جميع الأجهزة</button>
<button class="make-all-available-btn" onclick="makeAllAvailable()">جعل جميع الأجهزة متاحة</button>
</div>
<div>
<button class="filter-btn" onclick="filterStatus('available')">عرض المتاحة</button>
<button class="filter-btn" onclick="filterStatus('reserved')">عرض المحجوزة</button>
<button class="filter-btn" onclick="filterStatus('maintenance')">عرض الصيانة</button>
<button class="filter-btn" onclick="filterStatus('all')">عرض الكل</button>
</div>
</div>

<div class="analytics" id="analyticsPanel">
<h3>تحليلات المختبر</h3>
<div id="analyticsContent">جاري حساب الإحصائيات...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDkc95D39bAFOAPs2dq8MvsO1ililfb1ro",
  authDomain: "labcontrol-2ddc7.firebaseapp.com",
  databaseURL: "https://labcontrol-2ddc7-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "labcontrol-2ddc7",
  storageBucket: "labcontrol-2ddc7.appspot.com",
  messagingSenderId: "1080565939010",
  appId: "1:1080565939010:web:13f1c40512f4ae8b3c26db",
  measurementId: "G-3JVX3SD2GX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const labRef = ref(db,'lab');

let computers = [];
let selectedComputer = null;
let role = 'teacher';
let filter='all';

function recordHistory(action){
  if(selectedComputer){
    if(!selectedComputer.history) selectedComputer.history = [];
    selectedComputer.history.push({action, time:new Date().toLocaleString()});
  }
}

function savePCs(){
  set(labRef, computers).catch(err=>console.error("خطأ في الحفظ:", err));
}

function renderDashboard(){
  const dash = document.getElementById("dashboard");
  dash.innerHTML = '';
  computers.filter(c => filter==='all' || c.status===filter).forEach(c=>{
    if(!c.history) c.history = [];
    const div = document.createElement('div');
    div.className=`computer ${c.status}`;
    div.innerText=c.name;
    div.title=`الحالة: ${c.status==='available'?'متاح':c.status==='reserved'?'محجوز':'صيانة'}\nالملاحظات: ${c.notes || "لا يوجد"}`;
    div.onclick=()=>selectComputer(c.id);
    dash.appendChild(div);
  });
  updateAnalytics();
}

function selectComputer(id){
  selectedComputer = computers.find(c=>c.id===id);
  if(!selectedComputer.history) selectedComputer.history = [];
  document.getElementById("selectedComputerName").innerText=selectedComputer.name;
  document.getElementById("computerNotes").value=selectedComputer.notes;

  if(role==='teacher' && selectedComputer.status==='maintenance'){
    alert("هذا الجهاز تحت الصيانة!");
    return;
  }
  document.getElementById("controlPanel").style.display='block';
}

function updateNotes(){
  if(selectedComputer){
    selectedComputer.notes=document.getElementById("computerNotes").value;
  }
}

function reserveComputer(){ updateNotes(); if(selectedComputer){selectedComputer.status='reserved'; recordHistory('محجوز'); renderDashboard(); savePCs(); } }
function markMaintenance(){ updateNotes(); if(selectedComputer && role==='it'){selectedComputer.status='maintenance'; recordHistory('صيانة'); renderDashboard(); savePCs(); } }
function markAvailable(){ updateNotes(); if(selectedComputer){selectedComputer.status='available'; recordHistory('متاح'); renderDashboard(); savePCs(); } }
function reserveAll(){
  computers.forEach(c=>{
    if(!c.history) c.history = [];
    if(role==='teacher' && c.status!=='maintenance'){c.status='reserved'; c.history.push({action:'محجوز', time:new Date().toLocaleString()});} 
    else if(role==='it'){c.status='reserved'; c.history.push({action:'محجوز', time:new Date().toLocaleString()});}
  });
  renderDashboard(); savePCs();
}
function makeAllAvailable(){
  computers.forEach(c=>{
    if(!c.history) c.history = [];
    c.status='available';
    c.history.push({action:'متاح', time:new Date().toLocaleString()});
  });
  renderDashboard(); savePCs();
}
function filterStatus(status){ filter=status; renderDashboard(); }
function switchRole(){ role=document.getElementById("roleSelect").value; document.getElementById("controlPanel").style.display='none'; renderDashboard(); }

function updateAnalytics(){
  const total = computers.length;
  const available = computers.filter(c=>c.status==='available').length;
  const reserved = computers.filter(c=>c.status==='reserved').length;
  const maintenance = computers.filter(c=>c.status==='maintenance').length;
  document.getElementById('analyticsContent').innerHTML=
    `عدد الأجهزة الكلي: ${total} <br> متاحة: ${available} <br> محجوزة: ${reserved} <br> صيانة: ${maintenance}`;
}

onValue(labRef, snapshot => {
  if(snapshot.exists()){
    computers = snapshot.val();
    computers.forEach(c=>{ if(!c.history) c.history = []; });

    for(let i=1; i<=23; i++){
      if(!computers.find(c=>c.id===i)){
        computers.push({id:i, name:`جهاز-${i.toString().padStart(2,'0')}`, status:'available', notes:'', history:[]});
      }
    }

  } else {
    for(let i=1;i<=23;i++){
      computers.push({id:i, name:`جهاز-${i.toString().padStart(2,'0')}`, status:'available', notes:'', history:[]});
    }
  }
  renderDashboard();
});

window.reserveComputer = reserveComputer;
window.markMaintenance = markMaintenance;
window.markAvailable = markAvailable;
window.reserveAll = reserveAll;
window.makeAllAvailable = makeAllAvailable;
window.filterStatus = filterStatus;
window.switchRole = switchRole;

</script>

</body>
</html>

